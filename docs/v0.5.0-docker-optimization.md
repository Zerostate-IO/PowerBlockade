# v0.5.0 Docker Image Optimization Analysis

## Current State

### Image Overview

| Image | Base | Purpose | Build Type |
|-------|------|---------|------------|
| `powerblockade-admin-ui` | `python:3.12-alpine` | FastAPI admin interface | Single-stage |
| `powerblockade-dnstap-processor` | `alpine:3.20` | Go DNS event processor | Multi-stage |
| `powerblockade-recursor` | `powerdns/pdns-recursor-51` | DNS resolver | Overlay |
| `powerblockade-sync-agent` | `python:3.12-alpine` | Secondary node sync | Single-stage |

### Third-Party Images (from compose.yaml)

| Image | Size (approx) | Purpose |
|-------|---------------|---------|
| `postgres:16-alpine` | ~80MB | Database |
| `prom/prometheus:latest` | ~250MB | Metrics |
| `grafana/grafana:latest` | ~400MB | Dashboards |
| `powerdns/dnsdist-19:latest` | ~50MB | Edge DNS proxy |
| `powerdns/pdns-recursor-51:latest` | ~100MB | Base for recursor |
| `traefik:v3.2` (optional) | ~150MB | Reverse proxy |

---

## Image-by-Image Analysis

### 1. admin-ui (Python/FastAPI)

**Current Dockerfile Issues:**
```dockerfile
RUN apk add --no-cache build-base libffi-dev ca-certificates wget
```

**Problems:**
- `build-base` (~150MB) is installed but only needed for compiling Python packages
- `wget` is unused
- No multi-stage build - build deps remain in final image

**Dependencies Analysis:**
| Package | Required | Notes |
|---------|----------|-------|
| `fastapi` | Yes | Core framework |
| `uvicorn[standard]` | Yes | ASGI server |
| `jinja2` | Yes | Templating |
| `python-multipart` | Yes | Form parsing |
| `itsdangerous` | Yes | Session signing |
| `sqlalchemy` | Yes | ORM |
| `psycopg[binary]` | Yes | Postgres driver (binary = no build deps needed) |
| `alembic` | Yes | Migrations |
| `bcrypt` | Yes | Password hashing |
| `pydantic` | Yes | Validation |
| `pydantic-settings` | Yes | Config |
| `orjson` | Yes | Fast JSON (pre-built wheels) |
| `dnspython` | Yes | PTR lookups |
| `httpx` | Yes | HTTP client |
| `apscheduler` | Yes | Background jobs |
| `starlette-csrf` | **Remove?** | We have custom CSRF middleware |
| `websockets` | Yes | Live streaming |

**Optimization Opportunities:**
1. Multi-stage build: compile in builder, copy wheels to runtime
2. Remove `build-base` and `wget` from final image
3. Remove `starlette-csrf` (we use custom middleware)
4. Use `--no-compile` flag to skip .pyc generation
5. Consider `python:3.12-alpine` vs `python:3.12-slim-bookworm` (glibc vs musl)

**Estimated Savings:** ~150-200MB

---

### 2. dnstap-processor (Go)

**Current State:** Already well-optimized!
- Multi-stage build ✓
- CGO_ENABLED=0 for static binary ✓
- Minimal alpine runtime ✓
- Non-root user ✓

**Minor Improvements:**
1. Use `scratch` or `gcr.io/distroless/static` instead of `alpine:3.20`
2. Add `-trimpath` to go build for reproducibility
3. Use `UPX` compression (optional, adds startup latency)

**Current Estimated Size:** ~15-20MB
**With distroless:** ~8-12MB

---

### 3. recursor (PowerDNS)

**Current State:** Minimal overlay on upstream image
- Only adds entrypoint script
- Inherits upstream's optimization

**Analysis:**
- We can't change the base image (official PowerDNS)
- Entrypoint is already minimal (shell script, no extra packages)
- No optimization opportunities

**Note:** Consider pinning to specific version tag instead of `latest` for reproducibility.

---

### 4. sync-agent (Python)

**Current Dockerfile Issues:**
```dockerfile
RUN pip install --no-cache-dir -r requirements.txt
```

**Problems:**
- Uses `pip` instead of `uv` (slower, less efficient)
- Single-stage build

**Dependencies:**
| Package | Required | Notes |
|---------|----------|-------|
| `requests` | Yes | HTTP client (could switch to httpx for consistency) |

**Optimization Opportunities:**
1. Switch to `uv` for faster installs
2. This is a ~50-line Python script - could rewrite in Go for single static binary
3. Or use multi-stage Python build

**Estimated Current Size:** ~60MB
**With Go rewrite:** ~5MB

---

## Recommendations

### Priority 1: admin-ui (Highest Impact)

```dockerfile
# Builder stage
FROM python:3.12-alpine AS builder

RUN apk add --no-cache build-base libffi-dev
COPY --from=ghcr.io/astral-sh/uv:latest /uv /bin/uv

WORKDIR /app
COPY requirements.txt .
RUN uv pip install --system --no-cache -r requirements.txt

# Runtime stage  
FROM python:3.12-alpine

RUN apk add --no-cache ca-certificates libffi \
    && addgroup -g 1000 -S app && adduser -u 1000 -S -G app app

WORKDIR /app
COPY --from=builder /usr/local/lib/python3.12/site-packages /usr/local/lib/python3.12/site-packages
COPY --from=builder /usr/local/bin /usr/local/bin
COPY --chown=app:app app ./app
COPY --chown=app:app alembic ./alembic
COPY --chown=app:app alembic.ini .

USER app
EXPOSE 8080
CMD ["sh", "-c", "alembic upgrade head && uvicorn app.main:app --host 0.0.0.0 --port 8080"]
```

### Priority 2: dnstap-processor (Minor)

```dockerfile
# Change final stage from alpine to distroless
FROM gcr.io/distroless/static-debian12:nonroot

COPY --from=build /out/dnstap-processor /dnstap-processor
ENTRYPOINT ["/dnstap-processor"]
```

### Priority 3: sync-agent (Consider Go Rewrite)

**Option A:** Keep Python, optimize Dockerfile
**Option B:** Rewrite in Go (same approach as dnstap-processor)

Recommendation: Option B if we want <10MB image, Option A if Python is preferred.

---

## Security Improvements

### All Images:
1. Pin base image versions (avoid `:latest`)
2. Add `HEALTHCHECK` instructions
3. Use read-only root filesystem where possible
4. Drop all capabilities except required ones

### Compose-level:
```yaml
services:
  admin-ui:
    read_only: true
    tmpfs:
      - /tmp
    security_opt:
      - no-new-privileges:true
```

---

## Estimated Size Comparison

| Image | Current (est) | Optimized (est) | Savings |
|-------|---------------|-----------------|---------|
| admin-ui | ~350MB | ~150MB | ~200MB |
| dnstap-processor | ~20MB | ~10MB | ~10MB |
| recursor | ~100MB | ~100MB | 0 |
| sync-agent | ~60MB | ~10MB* | ~50MB |

*With Go rewrite

**Total Savings:** ~260MB across all images

---

## Implementation Plan

### Phase 1: admin-ui Multi-Stage Build
1. Create multi-stage Dockerfile
2. Remove `starlette-csrf` dependency (confirm custom middleware covers all cases)
3. Test build and verify functionality
4. Measure size reduction

### Phase 2: dnstap-processor Distroless
1. Switch to distroless base
2. Verify bbolt works without glibc
3. Test container startup

### Phase 3: sync-agent Decision
1. Evaluate Go rewrite effort (~2-4 hours)
2. If approved, rewrite sync-agent in Go
3. Otherwise, optimize Python Dockerfile

### Phase 4: Security Hardening
1. Add HEALTHCHECK to all images
2. Pin base image versions
3. Update compose.yaml with security options
