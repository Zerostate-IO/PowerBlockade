name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v0.6.0)'
        required: true
        type: string
      dry_run:
        description: 'Dry run (no pushes)'
        required: false
        type: boolean
        default: true
      skip_docker:
        description: 'Skip Docker builds'
        required: false
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Phase 1: Update versions in all files
  update-versions:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.validate.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate version
        id: validate
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "❌ Invalid version format: $VERSION"
            echo "Expected format: vX.Y.Z (e.g., v0.6.0)"
            exit 1
          fi
          echo "✅ Version format valid: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Update version in pyproject.toml
        run: |
          VERSION="${{ steps.validate.outputs.version }}"
          VERSION_WITHOUT_V="${VERSION#v}"
          sed -i "s/^version = \".*\"/version = \"$VERSION_WITHOUT_V\"/" admin-ui/pyproject.toml
          echo "✅ Updated pyproject.toml to $VERSION_WITHOUT_V"

      - name: Update version in settings.py
        run: |
          VERSION="${{ steps.validate.outputs.version }}"
          sed -i "s/^pb_version = \".*\"/pb_version = \"$VERSION\"/" admin-ui/app/settings.py
          echo "✅ Updated settings.py to $VERSION"

      - name: Update version in Dockerfiles
        run: |
          VERSION="${{ steps.validate.outputs.version }}"
          # Update admin-ui Dockerfile
          sed -i "s/^ARG PB_VERSION=\".*\"/ARG PB_VERSION=\"$VERSION\"/" admin-ui/Dockerfile
          
          # Update dnstap-processor Dockerfile
          sed -i "s/^ARG PB_VERSION=\".*\"/ARG PB_VERSION=\"$VERSION\"/" dnstap-processor/Dockerfile
          
          # Update sync-agent Dockerfile
          sed -i "s/^ARG PB_VERSION=\".*\"/ARG PB_VERSION=\"$VERSION\"/" sync-agent/Dockerfile
          
          echo "✅ Updated all Dockerfiles to $VERSION"

      - name: Update docker-compose.ghcr.yml image tags
        run: |
          VERSION="${{ steps.validate.outputs.version }}"
          sed -i "s|ghcr.io/zerostate-io/powerblockade-admin-ui:.*|ghcr.io/zerostate-io/powerblockade-admin-ui:$VERSION|" docker-compose.ghcr.yml
          sed -i "s|ghcr.io/zerostate-io/powerblockade-recursor:.*|ghcr.io/zerostate-io/powerblockade-recursor:$VERSION|" docker-compose.ghcr.yml
          sed -i "s|ghcr.io/zerostate-io/powerblockade-dnstap-processor:.*|ghcr.io/zerostate-io/powerblockade-dnstap-processor:$VERSION|" docker-compose.ghcr.yml
          sed -i "s|ghcr.io/zerostate-io/powerblockade-sync-agent:.*|ghcr.io/zerostate-io/powerblockade-sync-agent:$VERSION|" docker-compose.ghcr.yml
          echo "✅ Updated docker-compose.ghcr.yml image tags to $VERSION"

      - name: Check for modified files
        id: check_changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "✅ Files modified:"
            git status --porcelain
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "⚠️ No files were modified"
          fi

      - name: Commit version updates
        if: steps.check_changes.outputs.has_changes == 'true' && github.event.inputs.dry_run != 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Release ${{ steps.validate.outputs.version }}

          Co-authored-by: Sisyphus <clio-agent@sisyphuslabs.ai>"
          echo "✅ Changes committed"

      - name: Create and push Git tag
        if: github.event.inputs.dry_run != 'true'
        run: |
          VERSION="${{ steps.validate.outputs.version }}"
          git tag -a "$VERSION" -m "Release $VERSION

          Automated release created via GitHub Actions
          Co-authored-by: Sisyphus <clio-agent@sisyphuslabs.ai>"
          
          if [ "${{ github.event.inputs.dry_run }}" != "true" ]; then
            git push origin "$VERSION"
            echo "✅ Tag $VERSION pushed to origin"
          else
            echo "✅ Tag $VERSION created locally (dry run)"
          fi

  # Phase 2: Build and push Docker images
  build-and-push:
    runs-on: ubuntu-latest
    needs: update-versions
    if: github.event.inputs.skip_docker != 'true'
    strategy:
      matrix:
        include:
          - image: admin-ui
            context: ./admin-ui
            dockerfile: ./admin-ui/Dockerfile
          - image: recursor
            context: ./recursor
            dockerfile: ./recursor/Dockerfile
          - image: dnstap-processor
            context: ./dnstap-processor
            dockerfile: ./dnstap-processor/Dockerfile
          - image: sync-agent
            context: ./sync-agent
            dockerfile: ./sync-agent/Dockerfile
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          push: ${{ github.event.inputs.dry_run != 'true' }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-${{ matrix.image }}:${{ needs.update-versions.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-${{ matrix.image }}:latest
          build-args: |
            PB_VERSION=${{ needs.update-versions.outputs.version }}

      - name: Image build summary
        run: |
          echo "✅ Built and pushed ${{ matrix.image }}:${{ needs.update-versions.outputs.version }}"

  # Phase 3: Create GitHub Release
  create-release:
    runs-on: ubuntu-latest
    needs: [update-versions, build-and-push]
    if: github.event.inputs.dry_run != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        run: |
          VERSION="${{ needs.update-versions.outputs.version }}"
          PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -A 1 "^${VERSION}$" | tail -n 1)
          
          if [ -z "$PREVIOUS_TAG" ]; then
            # First release or no previous tag
            echo "changes<<EOF" >> $GITHUB_OUTPUT
            echo "### Changes" >> $GITHUB_OUTPUT
            echo "Initial release or first tagged version" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "changes<<EOF" >> $GITHUB_OUTPUT
            echo "### Changes since $PREVIOUS_TAG" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            git log --pretty=format:"- %s" "${PREVIOUS_TAG}..${VERSION}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ needs.update-versions.outputs.version }}';
            const changelog = `${{ toJSON(steps.changelog.outputs.changes) }}`;
            
            await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: version,
              name: `Release ${version}`,
              body: changelog,
              draft: false,
              prerelease: false
            });
            
            console.log(`✅ GitHub Release created for ${version}`);

  # Summary job
  summary:
    runs-on: ubuntu-latest
    needs: [update-versions, build-and-push, create-release]
    if: always()
    steps:
      - name: Release summary
        run: |
          echo "## Release Summary"
          echo ""
          echo "✅ Version: ${{ needs.update-versions.outputs.version }}"
          echo "✅ Dry run: ${{ github.event.inputs.dry_run }}"
          echo "✅ Docker builds: ${{ github.event.inputs.skip_docker != 'true' }}"
          echo ""
          echo "## Next Steps"
          echo "If dry_run=true, review the changes above and re-run with dry_run=false"
          echo "If skip_docker=true, Docker images were not built or pushed"