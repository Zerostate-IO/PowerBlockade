groups:
  - name: powerblockade
    rules:
      - alert: LowCacheHitRate
        expr: |
          (
            sum by (node) (powerblockade_recursor_cache_hits)
            / 
            (sum by (node) (powerblockade_recursor_cache_hits) + sum by (node) (powerblockade_recursor_cache_misses))
          ) * 100 < 50
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Low DNS cache hit rate on {{ $labels.node }}"
          description: "Cache hit rate is {{ $value | printf \"%.1f\" }}% (threshold: 50%)"

      - alert: CriticalCacheHitRate
        expr: |
          (
            sum by (node) (powerblockade_recursor_cache_hits)
            / 
            (sum by (node) (powerblockade_recursor_cache_hits) + sum by (node) (powerblockade_recursor_cache_misses))
          ) * 100 < 20
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Critical DNS cache hit rate on {{ $labels.node }}"
          description: "Cache hit rate is {{ $value | printf \"%.1f\" }}% (threshold: 20%)"

      - alert: HighServfailRate
        expr: |
          (
            sum by (node) (rate(powerblockade_recursor_servfail_answers[5m]))
            / 
            sum by (node) (rate(powerblockade_recursor_questions[5m]))
          ) * 100 > 5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High SERVFAIL rate on {{ $labels.node }}"
          description: "SERVFAIL rate is {{ $value | printf \"%.1f\" }}% of queries"

      - alert: HighTimeoutRate
        expr: |
          (
            sum by (node) (rate(powerblockade_recursor_outgoing_timeouts[5m]))
            / 
            sum by (node) (rate(powerblockade_recursor_all_outqueries[5m]))
          ) * 100 > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High upstream timeout rate on {{ $labels.node }}"
          description: "Timeout rate is {{ $value | printf \"%.1f\" }}% of outgoing queries"

      - alert: NodeMetricsStale
        expr: |
          time() - powerblockade_recursor_last_scrape_timestamp > 300
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Stale metrics from {{ $labels.node }}"
          description: "No metrics received from node for more than 5 minutes"

      - alert: RecursorDown
        expr: up{job="powerblockade"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "PowerBlockade service down"
          description: "Cannot scrape metrics from admin-ui"

      - alert: HighQueryLatency
        expr: |
          (
            sum by (node) (powerblockade_recursor_answers_slow)
            / 
            sum by (node) (powerblockade_recursor_questions)
          ) * 100 > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High query latency on {{ $labels.node }}"
          description: "{{ $value | printf \"%.1f\" }}% of queries have latency >1s"

      - alert: HighBlockRate
        expr: |
          (
            sum by (node) (rate(powerblockade_queries_blocked_total[5m]))
            / 
            sum by (node) (rate(powerblockade_queries_total[5m]))
          ) * 100 > 50
        for: 15m
        labels:
          severity: info
        annotations:
          summary: "High block rate on {{ $labels.node }}"
          description: "Block rate is {{ $value | printf \"%.1f\" }}% - may indicate malware or misconfiguration"

      - alert: HighNXDOMAINRate
        expr: |
          (
            sum by (node) (rate(powerblockade_recursor_nxdomain_answers[5m]))
            / 
            sum by (node) (rate(powerblockade_recursor_questions[5m]))
          ) * 100 > 20
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High NXDOMAIN rate on {{ $labels.node }}"
          description: "NXDOMAIN rate is {{ $value | printf \"%.1f\" }}% - may indicate DGA malware"

      - alert: ConcurrentQueriesHigh
        expr: powerblockade_recursor_concurrent_queries > 500
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High concurrent queries on {{ $labels.node }}"
          description: "{{ $value }} concurrent queries - check for DNS amplification or misconfiguration"

      - alert: NodeNotSyncing
        expr: |
          time() - powerblockade_node_last_heartbeat_timestamp > 600
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Secondary node {{ $labels.node }} not syncing"
          description: "No heartbeat from node for more than 10 minutes"
