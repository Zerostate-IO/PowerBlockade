{% extends "base.html" %}
{% block content %}
  <div class="grid gap-4 md:grid-cols-3">
    <div class="rounded-2xl border border-slate-800 bg-bg-800 p-5 md:col-span-2">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">Dashboard</h2>
        <div class="text-xs text-slate-400">Logged in as {{ user.username }}</div>
      </div>
      <p class="mt-2 text-sm text-slate-300">DNS performance and statistics.</p>

      <div class="mt-4 grid grid-cols-2 gap-2 sm:grid-cols-4">
        <div class="rounded-xl border border-slate-800 bg-bg-900 px-4 py-3">
          <div class="text-xs text-slate-400">Total queries (24h)</div>
          <div class="text-2xl font-semibold text-slate-100">{{ total }}</div>
        </div>
        <div class="rounded-xl border border-slate-800 bg-bg-900 px-4 py-3">
          <div class="text-xs text-slate-400">Blocked</div>
          <div class="text-2xl font-semibold text-red-400">{{ blocked }}</div>
        </div>
        <div class="rounded-xl border border-slate-800 bg-bg-900 px-4 py-3">
          <div class="text-xs text-slate-400">Cache hit rate</div>
          <div class="text-2xl font-semibold text-emerald-400">{{ "%.1f"|format(hit_rate) }}%</div>
        </div>
        <div class="rounded-xl border border-slate-800 bg-bg-900 px-4 py-3">
          <div class="text-xs text-slate-400">Time saved</div>
          <div class="text-2xl font-semibold text-cyan-400">{{ "%.1f"|format(time_saved / 1000) }}s</div>
        </div>
      </div>

      <div class="mt-6">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-sm font-semibold text-slate-200">Query History</h3>
          <div class="flex gap-1">
            <button data-window="1h" class="window-btn px-2 py-1 text-xs rounded bg-bg-900 text-slate-400 hover:text-slate-200">1h</button>
            <button data-window="6h" class="window-btn px-2 py-1 text-xs rounded bg-bg-900 text-slate-400 hover:text-slate-200">6h</button>
            <button data-window="12h" class="window-btn px-2 py-1 text-xs rounded bg-bg-900 text-slate-400 hover:text-slate-200">12h</button>
            <button data-window="24h" class="window-btn px-2 py-1 text-xs rounded bg-indigo-600 text-white">24h</button>
            <button data-window="3d" class="window-btn px-2 py-1 text-xs rounded bg-bg-900 text-slate-400 hover:text-slate-200">3d</button>
            <button data-window="7d" class="window-btn px-2 py-1 text-xs rounded bg-bg-900 text-slate-400 hover:text-slate-200">7d</button>
          </div>
        </div>
        <div id="query-chart" class="h-64"></div>
      </div>
    </div>

    <div class="rounded-2xl border border-slate-800 bg-bg-800 p-5">
      <div class="flex items-center justify-between">
        <h3 class="text-sm font-semibold text-slate-200">Health</h3>
        <a href="/system" class="text-xs text-cyan-300 hover:underline">View details</a>
      </div>

      <div class="mt-4 space-y-3">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <span class="inline-block w-2 h-2 rounded-full bg-emerald-400"></span>
            <span class="text-sm text-slate-300">Nodes</span>
          </div>
          <span class="text-sm font-medium text-slate-100">{{ node_count }} active</span>
        </div>

        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            {% if critical_count > 0 %}
            <span class="inline-block w-2 h-2 rounded-full bg-red-400"></span>
            {% elif warning_count > 0 %}
            <span class="inline-block w-2 h-2 rounded-full bg-amber-400"></span>
            {% else %}
            <span class="inline-block w-2 h-2 rounded-full bg-emerald-400"></span>
            {% endif %}
            <span class="text-sm text-slate-300">Status</span>
          </div>
          <span class="text-sm font-medium {% if critical_count > 0 %}text-red-400{% elif warning_count > 0 %}text-amber-400{% else %}text-emerald-400{% endif %}">
            {% if critical_count > 0 %}
              {{ critical_count }} critical
            {% elif warning_count > 0 %}
              {{ warning_count }} warning{{ 's' if warning_count != 1 else '' }}
            {% else %}
              All good
            {% endif %}
          </span>
        </div>
      </div>

      <div class="mt-4 pt-4 border-t border-slate-800">
        <div class="text-xs font-medium text-slate-400 mb-2">Chart Legend</div>
        <div class="flex flex-wrap gap-3">
          <div class="flex items-center gap-1.5">
            <span class="h-2.5 w-2.5 rounded-full bg-indigo-500"></span>
            <span class="text-xs text-slate-400">Total</span>
          </div>
          <div class="flex items-center gap-1.5">
            <span class="h-2.5 w-2.5 rounded-full bg-red-500"></span>
            <span class="text-xs text-slate-400">Blocked</span>
          </div>
          <div class="flex items-center gap-1.5">
            <span class="h-2.5 w-2.5 rounded-full bg-emerald-500"></span>
            <span class="text-xs text-slate-400">Cached</span>
          </div>
        </div>
      </div>

      <div class="mt-4 pt-4 border-t border-slate-800 text-xs text-slate-400">
        <a class="text-cyan-300 hover:underline" href="/precache">Precache</a> Â· 
        <a class="text-cyan-300 hover:underline" href="/system">System</a>
      </div>
    </div>
  </div>

  <!-- Live Query Stream -->
  <div class="mt-4 rounded-2xl border border-slate-800 bg-bg-800 p-5">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <h3 class="text-sm font-semibold text-slate-200">Live Queries</h3>
        <span id="stream-status" class="text-xs px-2 py-0.5 rounded-full bg-slate-700 text-slate-400">Disconnected</span>
      </div>
      <div class="flex items-center gap-3">
        <span id="stream-count" class="text-xs text-slate-400">0 queries</span>
        <button id="stream-toggle" class="px-3 py-1.5 text-xs rounded-lg bg-cyan-600 hover:bg-cyan-500 text-white font-medium">
          Start Stream
        </button>
        <button id="stream-clear" class="px-3 py-1.5 text-xs rounded-lg border border-slate-700 bg-bg-900 hover:bg-bg-700 text-slate-300">
          Clear
        </button>
      </div>
    </div>

    <div id="stream-container" class="mt-3 overflow-hidden rounded-xl border border-slate-800 bg-bg-900">
      <table class="min-w-full text-xs">
        <thead class="bg-bg-800 text-slate-400">
          <tr>
            <th class="px-3 py-2 text-left font-medium w-24">Time</th>
            <th class="px-3 py-2 text-left font-medium w-28">Client</th>
            <th class="px-3 py-2 text-left font-medium">Domain</th>
            <th class="px-3 py-2 text-left font-medium w-16">Type</th>
            <th class="px-3 py-2 text-left font-medium w-20">Status</th>
            <th class="px-3 py-2 text-left font-medium w-16">Latency</th>
          </tr>
        </thead>
        <tbody id="stream-body" class="divide-y divide-slate-800">
          <tr id="stream-placeholder">
            <td colspan="6" class="px-3 py-6 text-center text-slate-500">Click "Start Stream" to see live queries</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    (function() {
      let chart = null;
      let currentWindow = '24h';

      const chartOptions = {
        chart: {
          type: 'area',
          height: 256,
          background: 'transparent',
          toolbar: { show: false },
          zoom: { enabled: false },
          animations: { enabled: true, easing: 'easeinout', speed: 300 }
        },
        theme: { mode: 'dark' },
        colors: ['#6366f1', '#ef4444', '#10b981'],
        stroke: { curve: 'smooth', width: 2 },
        fill: {
          type: 'gradient',
          gradient: { opacityFrom: 0.4, opacityTo: 0.05 }
        },
        dataLabels: { enabled: false },
        legend: { show: false },
        grid: {
          borderColor: '#1e293b',
          strokeDashArray: 4
        },
        xaxis: {
          categories: [],
          labels: {
            style: { colors: '#64748b', fontSize: '10px' },
            rotate: 0,
            hideOverlappingLabels: true
          },
          axisBorder: { show: false },
          axisTicks: { show: false }
        },
        yaxis: {
          labels: { style: { colors: '#64748b', fontSize: '10px' } }
        },
        tooltip: {
          theme: 'dark',
          x: { show: true },
          y: { formatter: (val) => val.toLocaleString() }
        },
        series: [
          { name: 'Total', data: [] },
          { name: 'Blocked', data: [] },
          { name: 'Cached', data: [] }
        ]
      };

      async function loadChartData(window) {
        try {
          const resp = await fetch(`/api/analytics/history?window=${window}`);
          if (!resp.ok) throw new Error('Failed to fetch');
          const data = await resp.json();

          const labelInterval = Math.ceil(data.labels.length / 12);
          const sparseLabels = data.labels.map((l, i) => i % labelInterval === 0 ? l : '');

          chart.updateOptions({
            xaxis: { categories: sparseLabels }
          });
          chart.updateSeries([
            { name: 'Total', data: data.series.total },
            { name: 'Blocked', data: data.series.blocked },
            { name: 'Cached', data: data.series.cached }
          ]);
        } catch (err) {
          console.error('Chart load error:', err);
        }
      }

      function updateActiveButton(window) {
        document.querySelectorAll('.window-btn').forEach(btn => {
          if (btn.dataset.window === window) {
            btn.classList.remove('bg-bg-900', 'text-slate-400');
            btn.classList.add('bg-indigo-600', 'text-white');
          } else {
            btn.classList.remove('bg-indigo-600', 'text-white');
            btn.classList.add('bg-bg-900', 'text-slate-400');
          }
        });
      }

      document.addEventListener('DOMContentLoaded', function() {
        chart = new ApexCharts(document.querySelector('#query-chart'), chartOptions);
        chart.render();
        loadChartData(currentWindow);

        document.querySelectorAll('.window-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            currentWindow = this.dataset.window;
            updateActiveButton(currentWindow);
            loadChartData(currentWindow);
          });
        });
      });
    })();

    (function() {
      const userId = '{{ user.id }}';
      const maxRows = 50;
      let ws = null;
      let queryCount = 0;

      const statusEl = document.getElementById('stream-status');
      const countEl = document.getElementById('stream-count');
      const toggleBtn = document.getElementById('stream-toggle');
      const clearBtn = document.getElementById('stream-clear');
      const tbody = document.getElementById('stream-body');
      const placeholder = document.getElementById('stream-placeholder');

      const qtypeMap = {1: 'A', 2: 'NS', 5: 'CNAME', 6: 'SOA', 12: 'PTR', 15: 'MX', 16: 'TXT', 28: 'AAAA', 33: 'SRV', 65: 'HTTPS'};
      const rcodeMap = {0: 'NOERROR', 1: 'FORMERR', 2: 'SERVFAIL', 3: 'NXDOMAIN', 4: 'NOTIMP', 5: 'REFUSED'};

      function formatTime(isoStr) {
        const d = new Date(isoStr);
        return d.toLocaleTimeString('en-US', {hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit'});
      }

      function setStatus(status, color) {
        statusEl.textContent = status;
        statusEl.className = 'text-xs px-2 py-0.5 rounded-full';
        if (color === 'green') statusEl.classList.add('bg-emerald-900', 'text-emerald-400');
        else if (color === 'yellow') statusEl.classList.add('bg-yellow-900', 'text-yellow-400');
        else statusEl.classList.add('bg-slate-700', 'text-slate-400');
      }

      function updateCount() {
        countEl.textContent = queryCount.toLocaleString() + ' queries';
      }

      function addRow(event) {
        if (placeholder) placeholder.remove();
        
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-bg-700' + (event.blocked ? ' bg-red-950/30' : '');
        
        const qtype = qtypeMap[event.qtype] || event.qtype;
        const rcode = rcodeMap[event.rcode] || event.rcode;
        const latency = event.latency_ms !== null ? event.latency_ms + 'ms' : '-';
        const statusClass = event.blocked ? 'text-red-400' : 'text-emerald-400';
        const statusText = event.blocked ? 'Blocked' : rcode;

        tr.innerHTML = `
          <td class="px-3 py-2 whitespace-nowrap text-slate-400">${formatTime(event.ts)}</td>
          <td class="px-3 py-2 text-slate-300 font-mono text-[10px]">${event.client_ip}</td>
          <td class="px-3 py-2 font-mono text-slate-200 truncate max-w-xs" title="${event.qname}">${event.qname}</td>
          <td class="px-3 py-2 text-slate-400">${qtype}</td>
          <td class="px-3 py-2 ${statusClass}">${statusText}</td>
          <td class="px-3 py-2 text-slate-400">${latency}</td>
        `;

        tbody.insertBefore(tr, tbody.firstChild);
        queryCount++;
        updateCount();

        while (tbody.children.length > maxRows) {
          tbody.removeChild(tbody.lastChild);
        }
      }

      function connect() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/stream?user_id=${userId}`;
        
        setStatus('Connecting...', 'yellow');
        ws = new WebSocket(wsUrl);

        ws.onopen = function() {
          setStatus('Connected', 'green');
          toggleBtn.textContent = 'Stop Stream';
        };

        ws.onmessage = function(e) {
          const msg = JSON.parse(e.data);
          if (msg.type === 'events' && msg.data) {
            msg.data.forEach(addRow);
          }
        };

        ws.onclose = function(e) {
          setStatus('Disconnected', 'gray');
          toggleBtn.textContent = 'Start Stream';
          ws = null;
        };

        ws.onerror = function(e) {
          console.error('WebSocket error:', e);
          setStatus('Error', 'yellow');
        };
      }

      function disconnect() {
        if (ws) {
          ws.close();
          ws = null;
        }
      }

      function clearStream() {
        tbody.innerHTML = '<tr id="stream-placeholder"><td colspan="6" class="px-3 py-6 text-center text-slate-500">Click "Start Stream" to see live queries</td></tr>';
        queryCount = 0;
        updateCount();
      }

      toggleBtn.addEventListener('click', function() {
        if (ws && ws.readyState === WebSocket.OPEN) {
          disconnect();
        } else {
          connect();
        }
      });

      clearBtn.addEventListener('click', clearStream);
    })();
  </script>
{% endblock %}
