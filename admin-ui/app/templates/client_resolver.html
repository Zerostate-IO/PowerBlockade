{% extends "base.html" %}
{% block content %}
  <div class="flex items-end justify-between">
    <div>
      <h1 class="text-xl font-semibold">Client Name Resolution</h1>
      <p class="mt-1 text-sm text-slate-400">Map IP subnets to DNS servers for PTR (reverse DNS) lookups to resolve client hostnames</p>
    </div>
    <a href="/clients" class="rounded-lg border border-slate-700 bg-bg-900 px-4 py-2 text-sm hover:bg-bg-700">View Clients</a>
  </div>

  {% if message %}
  <div class="mt-4 rounded-lg border border-slate-700 bg-bg-800 px-3 py-2 text-sm text-slate-200">{{ message }}</div>
  {% endif %}

  <div class="mt-4 rounded-2xl border border-slate-800 bg-bg-800 p-5">
    <h2 class="text-sm font-semibold text-slate-200">Add resolver rule</h2>
    <form class="mt-3 space-y-3" method="post" action="/clients/resolver/add">
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="text-sm text-slate-300">Subnet (CIDR)</label>
          <input class="mt-1 w-full rounded-lg border border-slate-700 bg-bg-900 px-3 py-2" name="subnet" placeholder="192.168.1.0/24" required />
        </div>
        <div>
          <label class="text-sm text-slate-300">Nameserver (host:port)</label>
          <input class="mt-1 w-full rounded-lg border border-slate-700 bg-bg-900 px-3 py-2" name="nameserver" placeholder="192.168.1.1" required />
        </div>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="text-sm text-slate-300">Description (optional)</label>
          <input class="mt-1 w-full rounded-lg border border-slate-700 bg-bg-900 px-3 py-2" name="description" placeholder="LAN clients" />
        </div>
        <div>
          <label class="text-sm text-slate-300">Priority (lower = higher priority)</label>
          <input type="number" class="mt-1 w-full rounded-lg border border-slate-700 bg-bg-900 px-3 py-2" name="priority" value="100" />
        </div>
      </div>
      <button class="rounded-lg border border-slate-700 bg-bg-900 px-3 py-2 text-sm hover:bg-bg-700" type="submit">Add rule</button>
    </form>
  </div>

  {% if rules %}
  <div class="mt-4 overflow-hidden rounded-2xl border border-slate-800 bg-bg-800">
    <div class="bg-bg-900 px-4 py-2 text-sm font-semibold text-slate-200">Resolver rules</div>
    <table class="min-w-full text-sm">
      <thead class="bg-bg-900 text-slate-300">
        <tr>
          <th class="px-4 py-3 text-left">Priority</th>
          <th class="px-4 py-3 text-left">Subnet</th>
          <th class="px-4 py-3 text-left">Nameserver</th>
          <th class="px-4 py-3 text-left">Description</th>
          <th class="px-4 py-3 text-left">Status</th>
          <th class="px-4 py-3 text-right">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-slate-800">
        {% for r in rules %}
        <tr class="hover:bg-bg-700 {% if not r.enabled %}opacity-50{% endif %}">
          <td class="px-4 py-3 text-slate-400">{{ r.priority }}</td>
          <td class="px-4 py-3 text-slate-200 font-mono">{{ r.subnet }}</td>
          <td class="px-4 py-3 text-slate-300 font-mono">{{ r.nameserver }}</td>
          <td class="px-4 py-3 text-slate-400">{{ r.description or '-' }}</td>
          <td class="px-4 py-3">
            {% if r.enabled %}
            <span class="rounded-full bg-emerald-900/30 px-2 py-0.5 text-xs text-emerald-400">enabled</span>
            {% else %}
            <span class="rounded-full bg-slate-700/30 px-2 py-0.5 text-xs text-slate-400">disabled</span>
            {% endif %}
          </td>
          <td class="px-4 py-3 text-right space-x-2">
            <form method="post" action="/clients/resolver/toggle" class="inline">
              <input type="hidden" name="id" value="{{ r.id }}" />
              <button class="rounded-md border border-slate-700 bg-bg-900 px-2 py-1 text-xs hover:bg-bg-700" type="submit">{% if r.enabled %}disable{% else %}enable{% endif %}</button>
            </form>
            <form method="post" action="/clients/resolver/delete" class="inline">
              <input type="hidden" name="id" value="{{ r.id }}" />
              <button type="submit" class="rounded-md border border-slate-700 bg-bg-900 px-2 py-1 text-xs hover:bg-bg-700">Delete</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="mt-4 rounded-2xl border border-slate-800 bg-bg-800 p-5 text-center text-sm text-slate-400">
    No resolver rules configured. Add a rule above to enable automatic client name resolution.
  </div>
  {% endif %}

  <div class="mt-4 rounded-2xl border border-slate-800 bg-bg-800 p-5">
    <h2 class="text-sm font-semibold text-slate-200">How it works</h2>
    <p class="mt-2 text-sm text-slate-400">
      When a DNS query comes from a client IP, PowerBlockade checks if the IP matches any configured subnet.
      If a match is found, it performs a PTR (reverse DNS) lookup against the specified nameserver to get the hostname.
      Results are cached for 1 hour. Most home routers provide PTR records for DHCP clients.
    </p>
  </div>
{% endblock %}
